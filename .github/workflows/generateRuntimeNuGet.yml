name: Generate Runtime NuGet Packages

# Controls when the workflow will run
on:
  workflow_dispatch:
    inputs:
      apps:
        description: Comma separated list of apps (leave empty to use APPS secret)
        required: false
        default: ''
      dependencies:
        description: Comma separated list of dependencies (leave empty to use DEPENDENCIES secret)
        required: false
        default: ''
      country:
        description: Country for the main runtime version (leave empty to use COUNTRY variable, default is w1)
        required: false
        default: ''
      additionalCountries:
        description: Comma separated list of additional countries (leave empty to use ADDITIONALCOUNTRIES variable, default is none)
        required: false
        default: ''
      artifactVersion:
        description: Business Central artifacts version (leave empty to use ARTIFACTVERSION variable, default is to auto-calculate needed artifacts)
        required: false
        default: ''
      artifactType:
        description: Type of Business Central artifacts to use, onprem or sandbox (leave empty to use ARTIFACTTYPE variable, default is sandbox)
        required: false
        default: ''
      nuGetServerUrl:
        description: NuGet server URL (leave empty to use RUNTIMENUGETSERVERURL or NUGETSERVERURL variable)
        required: false
        default: ''
      nuGetToken:
        description: NuGet auth token (leave empty to use RUNTIMENUGETTOKEN or NUGETTOKEN secret)
        required: false
        default: ''

jobs:
  DetermineArtifacts:
    name: Determine Business Central Artifacts
    runs-on: [ ubuntu-latest ]
    outputs:
      artifactVersions: ${{ steps.determineArtifacts.outputs.ArtifactVersions }}
      artifactVersionCount: ${{ steps.determineArtifacts.outputs.ArtifactVersionCount }}
      runtimeDependencyPackageIds: ${{ steps.determineArtifacts.outputs.RuntimeDependencyPackageIds }}
    steps:
      - name: Mask input
        shell: pwsh
        run: |
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            $eventPath = Get-Content -Encoding UTF8 -Path $env:GITHUB_EVENT_PATH -Raw | ConvertFrom-Json
            if ($null -ne $eventPath.inputs) {
              $eventPath.inputs.psObject.Properties | Where-Object { @('Apps','Dependencies','NuGetToken') -contains $_.Name } | ForEach-Object {
                $property = $_.Name
                $value = $eventPath.inputs."$property"
                Write-Host "::add-mask::$value"
                $value.Split(',') | ForEach-Object {
                  Write-Host "::add-mask::$($_.Trim())"
                }
              }
            }
          }
        
      - name: Checkout
        uses: actions/checkout@v3

      - name: Determine Artifacts
        id: determineArtifacts
        shell: pwsh
        env:
          nuGetToken: ${{ github.event.inputs.nuGetToken != '' && github.event.inputs.nuGetToken || (secrets.RUNTIMENUGETTOKEN != '' && secrets.RUNTIMENUGETTOKEN || secrets.NUGETTOKEN) }}
          nuGetServerUrl: ${{ github.event.inputs.nuGetServerUrl != '' && github.event.inputs.nuGetServerUrl || (vars.RUNTIMENUGETSERVERURL != '' && vars.RUNTIMENUGETSERVERURL || vars.NUGETSERVERURL) }}
          apps: ${{ github.event.inputs.apps != '' && github.event.inputs.apps || secrets.APPS }}
          country: ${{ github.event.inputs.country != '' && github.event.inputs.country || vars.COUNTRY }}
          artifactVersion: ${{ github.event.inputs.artifactVersion != '' && github.event.inputs.artifactVersion || vars.ARTIFACTVERSION }}
          artifactType: ${{ github.event.inputs.artifactType != '' && github.event.inputs.artifactType || vars.ARTIFACTTYPE }}
        run: |
          . (Join-Path $env:GITHUB_WORKSPACE "DetermineArtifacts.ps1")

  GenerateRuntimeNuGetPackages:
    name: Runtime
    needs: [ DetermineArtifacts ]
    if: needs.DetermineArtifacts.outputs.artifactVersionCount > 0
    runs-on: [ windows-latest ]
    strategy:
      matrix:
        include: ${{ fromJson(needs.DetermineArtifacts.outputs.artifactVersions) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate Runtime NuGet Packages
        shell: pwsh
        env:
          nuGetToken: ${{ github.event.inputs.nuGetToken != '' && github.event.inputs.nuGetToken || (secrets.RUNTIMENUGETTOKEN != '' && secrets.RUNTIMENUGETTOKEN || secrets.NUGETTOKEN) }}
          nuGetServerUrl: ${{ github.event.inputs.nuGetServerUrl != '' && github.event.inputs.nuGetServerUrl || (vars.RUNTIMENUGETSERVERURL != '' && vars.RUNTIMENUGETSERVERURL || vars.NUGETSERVERURL) }}
          apps: ${{ github.event.inputs.apps != '' && github.event.inputs.apps || secrets.APPS }}
          dependencies: ${{ github.event.inputs.dependencies != '' && github.event.inputs.dependencies || secrets.DEPENDENCIES }}
          country: ${{ github.event.inputs.country != '' && github.event.inputs.country || vars.COUNTRY }}
          additionalCountries: ${{ github.event.inputs.additionalCountries != '' && github.event.inputs.additionalCountries || vars.ADDITIONALCOUNTRIES }}
          artifactType: ${{ github.event.inputs.artifactType != '' && github.event.inputs.artifactType || vars.ARTIFACTTYPE }}
          artifactVersion: ${{ matrix.artifactVersion }}
          incompatibleArtifactVersion: ${{ matrix.incompatibleArtifactVersion }}
          runtimeDependencyPackageIds: ${{ needs.DetermineArtifacts.outputs.runtimeDependencyPackageIds }}
        run: |
          . (Join-Path $env:GITHUB_WORKSPACE "GenerateRuntimeNuGetPackages.ps1")

  GenerateIndirectNuGetPackage:
    name: Generate Indirect NuGet Package
    needs: [ DetermineArtifacts, GenerateRuntimeNuGetPackages ]
    if: needs.DetermineArtifacts.outputs.artifactVersionCount > 0
    runs-on: [ ubuntu-latest ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate Indirect NuGet Package
        shell: pwsh
        env:
          nuGetToken: ${{ github.event.inputs.nuGetToken != '' && github.event.inputs.nuGetToken || (secrets.RUNTIMENUGETTOKEN != '' && secrets.RUNTIMENUGETTOKEN || secrets.NUGETTOKEN) }}
          nuGetServerUrl: ${{ github.event.inputs.nuGetServerUrl != '' && github.event.inputs.nuGetServerUrl || (vars.RUNTIMENUGETSERVERURL != '' && vars.RUNTIMENUGETSERVERURL || vars.NUGETSERVERURL) }}
          apps: ${{ github.event.inputs.apps != '' && github.event.inputs.apps || secrets.APPS }}
        run: |
          . (Join-Path $env:GITHUB_WORKSPACE "GenerateIndirectPackage.ps1")
